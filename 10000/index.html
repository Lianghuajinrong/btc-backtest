<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>æ¯”ç‰¹å¸åŒå‡çº¿å›æµ‹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg: #050712;
        --card: rgba(18, 25, 48, 0.75);
        --border: rgba(82, 97, 255, 0.25);
        --text: #e8ecf5;
        --muted: #8fa0c2;
        --accent: linear-gradient(135deg, #7cf4ff, #7f5dff 45%, #ff7fd1);
        --glow: 0 20px 60px rgba(127, 93, 255, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Inter", "SF Pro Display", "Segoe UI", system-ui, -apple-system,
          "PingFang SC", "Microsoft YaHei", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at 20% 20%, #0c1130, #050712 45%),
          radial-gradient(circle at 80% 10%, #1a0f30, transparent 35%),
          var(--bg);
        min-height: 100vh;
      }
      .grid-bg::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: linear-gradient(rgba(255, 255, 255, 0.04) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 255, 255, 0.04) 1px, transparent 1px);
        background-size: 32px 32px;
        mask-image: radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.35), transparent 60%);
        pointer-events: none;
        z-index: 0;
      }
      .container {
        position: relative;
        z-index: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 18px 48px;
      }
      h1 {
        font-size: 30px;
        margin: 0 0 10px;
        background: var(--accent);
        -webkit-background-clip: text;
        color: transparent;
        letter-spacing: 0.2px;
      }
      .subtitle {
        color: var(--muted);
        margin-bottom: 24px;
        font-size: 14px;
      }
      .card {
        position: relative;
        background: var(--card);
        border-radius: 18px;
        padding: 20px;
        border: 1px solid var(--border);
        box-shadow: var(--glow);
        backdrop-filter: blur(12px);
      }
      .card::after {
        content: "";
        position: absolute;
        inset: 1px;
        border-radius: 17px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.04), transparent 30%),
          linear-gradient(315deg, rgba(124, 244, 255, 0.05), transparent 40%);
        pointer-events: none;
      }
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 12px;
      }
      .form-group {
        flex: 1 1 140px;
        min-width: 130px;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
        color: var(--muted);
      }
      input[type="number"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(124, 244, 255, 0.18);
        background: rgba(9, 12, 26, 0.9);
        color: var(--text);
        font-size: 14px;
        outline: none;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      }
      input[type="number"]:focus {
        border-color: rgba(127, 93, 255, 0.7);
        box-shadow: 0 0 0 2px rgba(127, 93, 255, 0.25);
      }
      button {
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        background: var(--accent);
        color: #0a0c1b;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 12px 35px rgba(127, 93, 255, 0.45);
        letter-spacing: 0.2px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }
      .status {
        margin-top: 6px;
        font-size: 13px;
        color: var(--muted);
      }
      .summary {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 12px;
        font-size: 13px;
        color: var(--text);
      }
      .summary-item {
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(127, 93, 255, 0.25);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      }
      .summary-label {
        color: var(--muted);
        margin-right: 4px;
      }
      .summary-value {
        font-weight: 700;
      }
      .summary-value.pos {
        color: #7cf4ff;
      }
      .summary-value.neg {
        color: #ff7f9c;
      }
      .charts {
        margin-top: 20px;
      }
      .chart-wrapper {
        position: relative;
        background: radial-gradient(circle at 20% 20%, rgba(127, 93, 255, 0.08), transparent 45%),
          rgba(9, 12, 26, 0.92);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid rgba(124, 244, 255, 0.12);
        margin-bottom: 18px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
      }
      .chart-title {
        font-size: 14px;
        margin-bottom: 8px;
        color: var(--text);
        letter-spacing: 0.2px;
      }
      canvas {
        background: transparent;
      }
      @media (max-width: 640px) {
        .card {
          padding: 16px 12px 18px;
        }
        h1 {
          font-size: 24px;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>æ¯”ç‰¹å¸åŒå‡çº¿ç­–ç•¥å›æµ‹<span class="kitty-gif" role="img" aria-label="å°çŒ«è·³èˆ">ğŸ±</span></h1>
      <div class="subtitle">
        å®ç›˜å†å²æ—¥çº¿æ•°æ®ï¼ˆBTC-USDï¼‰ï¼Œå¯å®æ—¶è°ƒæ•´çŸ­é•¿å‡çº¿å‚æ•°æŸ¥çœ‹ç­–ç•¥è¡¨ç°ã€‚
      </div>

      <div class="card">
        <div class="form-row">
          <div class="form-group">
            <label for="shortMA">çŸ­å‡çº¿å‘¨æœŸï¼ˆå¤©ï¼‰</label>
            <input id="shortMA" type="number" min="2" max="200" value="10" />
          </div>
          <div class="form-group">
            <label for="longMA">é•¿å‡çº¿å‘¨æœŸï¼ˆå¤©ï¼‰</label>
            <input id="longMA" type="number" min="5" max="400" value="50" />
          </div>
          <div class="form-group">
            <label for="capital">åˆå§‹èµ„é‡‘ï¼ˆUSDï¼‰</label>
            <input id="capital" type="number" min="100" step="100" value="10000" />
          </div>
          <div class="form-group" style="align-self: flex-end">
            <button id="runBtn">è¿è¡Œå›æµ‹</button>
          </div>
        </div>
        <div class="status" id="statusText">ç­‰å¾…å›æµ‹å‚æ•°...</div>

        <div class="summary" id="summary"></div>

        <div class="charts">
          <div class="chart-wrapper">
            <div class="chart-title">ä»·æ ¼ä¸åŒå‡çº¿</div>
            <canvas id="priceChart" height="260"></canvas>
          </div>
          <div class="chart-wrapper">
            <div class="chart-title">ç­–ç•¥å‡€å€¼æ›²çº¿</div>
            <canvas id="equityChart" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      // è‡ªåŠ¨æ£€æµ‹APIåœ°å€ï¼šç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨æ£€æµ‹ï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°åœ°å€
      function getApiBase() {
        // æœ¬åœ°å¼€å‘ç¯å¢ƒ
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          return "http://127.0.0.1:8000";
        }
        
        // ç”Ÿäº§ç¯å¢ƒï¼šä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¦åˆ™ä½¿ç”¨Renderåç«¯URL
        // å¦‚æœå‰ç«¯éƒ¨ç½²åœ¨Vercelï¼Œå¯ä»¥é€šè¿‡Vercelçš„ç¯å¢ƒå˜é‡è®¾ç½® API_BASE_URL
        if (window.API_BASE_URL) {
          return window.API_BASE_URL;
        }
        
        // Renderåç«¯URLï¼ˆå·²éƒ¨ç½²ï¼‰
        const renderBackendUrl = "https://btc-backtest.onrender.com";
        
        return renderBackendUrl;
      }
      
      const API_BASE = getApiBase();
      
      // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥åç«¯URL
      console.log("API Base URL:", API_BASE);

      const shortInput = document.getElementById("shortMA");
      const longInput = document.getElementById("longMA");
      const capitalInput = document.getElementById("capital");
      const runBtn = document.getElementById("runBtn");
      const statusText = document.getElementById("statusText");
      const summaryEl = document.getElementById("summary");

      let priceChart;
      let equityChart;

      function createCharts() {
        const priceCtx = document.getElementById("priceChart").getContext("2d");
        const equityCtx = document.getElementById("equityChart").getContext("2d");

        priceChart = new Chart(priceCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "æ”¶ç›˜ä»·",
                data: [],
                borderColor: "#facc15",
                backgroundColor: "rgba(250, 204, 21, 0.1)",
                borderWidth: 1.3,
                pointRadius: 0,
              },
              {
                label: "çŸ­å‡çº¿",
                data: [],
                borderColor: "#22c55e",
                backgroundColor: "transparent",
                borderWidth: 1.4,
                pointRadius: 0,
              },
              {
                label: "é•¿å‡çº¿",
                data: [],
                borderColor: "#38bdf8",
                backgroundColor: "transparent",
                borderWidth: 1.4,
                pointRadius: 0,
              },
            ],
          },
          options: {
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                labels: {
                  color: "#e5e7eb",
                  font: {
                    size: 11,
                  },
                },
              },
            },
            scales: {
              x: {
                ticks: {
                  color: "#9ca3af",
                  maxTicksLimit: 8,
                },
                grid: {
                  color: "rgba(55, 65, 81, 0.4)",
                },
              },
              y: {
                ticks: {
                  color: "#9ca3af",
                },
                grid: {
                  color: "rgba(31, 41, 55, 0.7)",
                },
              },
            },
          },
        });

        equityChart = new Chart(equityCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "ç­–ç•¥å‡€å€¼",
                data: [],
                borderColor: "#a855f7",
                backgroundColor: "rgba(168, 85, 247, 0.15)",
                borderWidth: 1.6,
                pointRadius: 0,
                fill: true,
              },
            ],
          },
          options: {
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                labels: {
                  color: "#e5e7eb",
                  font: {
                    size: 11,
                  },
                },
              },
            },
            scales: {
              x: {
                ticks: {
                  color: "#9ca3af",
                  maxTicksLimit: 8,
                },
                grid: {
                  color: "rgba(55, 65, 81, 0.4)",
                },
              },
              y: {
                ticks: {
                  color: "#9ca3af",
                },
                grid: {
                  color: "rgba(31, 41, 55, 0.7)",
                },
              },
            },
          },
        });
      }

      function updateSummary(summary, params) {
        summaryEl.innerHTML = "";
        if (!summary) return;

        const fmtPct = (v, digits = 2) =>
          v === null || v === undefined || Number.isNaN(v)
            ? "--"
            : `${v.toFixed(digits)}%`;
        const fmtNum = (v, digits = 2) =>
          v === null || v === undefined || Number.isNaN(v)
            ? "--"
            : v.toFixed(digits);

        const totalReturn = summary.total_return_pct ?? 0;
        const maxDd = summary.max_drawdown_pct ?? 0;
        const numTrades = summary.num_trades ?? 0;
        const cagr = summary.cagr_pct;
        const sharpe = summary.sharpe_ratio;
        const winRate = summary.win_rate_pct;
        const pf = summary.profit_factor;
        const avgWin = summary.avg_win_pct;
        const avgLoss = summary.avg_loss_pct;
        const avgHold = summary.avg_hold_days;

        const items = [
          { label: "çŸ­/é•¿å‡çº¿", value: `${params.short}/${params.long}` },
          {
            label: "åˆå§‹èµ„é‡‘",
            value: params.initial_capital.toLocaleString("en-US", {
              maximumFractionDigits: 0,
            }),
          },
          { label: "æ€»æ”¶ç›Š", value: fmtPct(totalReturn), posNeg: totalReturn },
          { label: "å¹´åŒ–æ”¶ç›Š", value: fmtPct(cagr ?? NaN), posNeg: cagr },
          { label: "å¤æ™®æ¯”ç‡", value: fmtNum(sharpe ?? NaN), posNeg: sharpe },
          { label: "æœ€å¤§å›æ’¤", value: fmtPct(maxDd), posNeg: -Math.abs(maxDd) },
          { label: "äº¤æ˜“æ¬¡æ•°", value: numTrades },
          { label: "èƒœç‡", value: fmtPct(winRate ?? NaN), posNeg: winRate },
          {
            label: "ç›ˆäºæ¯”",
            value: pf === null || pf === undefined ? "--" : fmtNum(pf, 2),
            posNeg: pf,
          },
          {
            label: "å¹³å‡ç›ˆåˆ©",
            value: fmtPct(avgWin ?? NaN),
            posNeg: avgWin,
          },
          {
            label: "å¹³å‡äºæŸ",
            value: fmtPct(avgLoss ?? NaN),
            posNeg: avgLoss ? -Math.abs(avgLoss) : avgLoss,
          },
          {
            label: "å¹³å‡æŒä»“å¤©æ•°",
            value:
              avgHold === null || avgHold === undefined
                ? "--"
                : `${avgHold.toFixed(1)} å¤©`,
          },
        ];

        items.forEach((it) => {
          const div = document.createElement("div");
          div.className = "summary-item";
          const label = document.createElement("span");
          label.className = "summary-label";
          label.textContent = it.label + "ï¼š";
          const value = document.createElement("span");
          value.className = "summary-value";
          if (typeof it.posNeg === "number" && !Number.isNaN(it.posNeg)) {
            if (it.posNeg > 0) value.classList.add("pos");
            if (it.posNeg < 0) value.classList.add("neg");
          }
          value.textContent = it.value;
          div.appendChild(label);
          div.appendChild(value);
          summaryEl.appendChild(div);
        });
      }

      async function runBacktest() {
        const short = parseInt(shortInput.value, 10);
        const long = parseInt(longInput.value, 10);
        const capital = parseFloat(capitalInput.value);

        if (isNaN(short) || isNaN(long) || isNaN(capital)) {
          alert("è¯·è¾“å…¥åˆæ³•çš„å‚æ•°");
          return;
        }
        if (short >= long) {
          alert("çŸ­å‡çº¿å¿…é¡»å°äºé•¿å‡çº¿");
          return;
        }

        runBtn.disabled = true;
        statusText.textContent = "æ­£åœ¨è¯·æ±‚åç«¯å¹¶è¿è¡Œå›æµ‹ï¼Œè¯·ç¨å€™...";

        try {
          const url = `${API_BASE}/api/backtest/double_ma?short=${short}&long=${long}&initial_capital=${capital}`;
          const resp = await fetch(url);
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || `HTTP ${resp.status}`);
          }
          const data = await resp.json();

          const curve = data.equity_curve || [];
          if (!curve.length) {
            statusText.textContent =
              "å›æµ‹ç»“æœä¸ºç©ºï¼ˆå¯èƒ½æ˜¯æ•°æ®ä¸è¶³æˆ–å‚æ•°ä¸åˆé€‚ï¼‰ã€‚";
            runBtn.disabled = false;
            return;
          }

          const labels = curve.map((d) => d.date);
          const close = curve.map((d) => d.close);
          const maShort = curve.map((d) => d.ma_short);
          const maLong = curve.map((d) => d.ma_long);
          const equity = curve.map((d) => d.equity);

          priceChart.data.labels = labels;
          priceChart.data.datasets[0].data = close;
          priceChart.data.datasets[1].data = maShort;
          priceChart.data.datasets[2].data = maLong;
          priceChart.update("none");

          equityChart.data.labels = labels;
          equityChart.data.datasets[0].data = equity;
          equityChart.update("none");

          updateSummary(data.summary, data.params);
          statusText.textContent = `å›æµ‹å®Œæˆï¼Œå…± ${labels.length} æ ¹ K çº¿ï¼Œäº¤æ˜“æ¬¡æ•° ${data.summary?.num_trades ?? 0}ã€‚`;
        } catch (err) {
          console.error(err);
          statusText.textContent = "å›æµ‹å¤±è´¥ï¼š" + err.message;
        } finally {
          runBtn.disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        createCharts();
        runBtn.addEventListener("click", runBacktest);
      });
    </script>
  </body>
</html>



